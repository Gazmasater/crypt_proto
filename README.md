[https://edis-global.vercel.app/ru/vps-hosting/singapore-singapore
](https://sg.edisglobal.com/)



git pull --rebase origin privat
git push origin privat


BOOK_INTERVAL=100ms
SYMBOLS_FILE=triangles_markets.csv
DEBUG=false



base1,quote1,base2,quote2,base3,quote3
ETC,BTC,BTC,USDT,ETC,USDT
ETC,BTC,BTC,USDC,ETC,USDC
ETC,USDT,USDC,USDT,ETC,USDC
OM,USDT,USDC,USDT,OM,USDC
PUMP,USDT,USDC,USDT,PUMP,USDC
LBTC,USDT,USDC,USDT,LBTC,USDC
AGT,USDT,USDC,USDT,AGT,USDC
RAY,USDT,USDC,USDT,RAY,USDC
PI,EUR,EUR,USDT,PI,USDT
PI,EUR,EUR,USDC,PI,USDC
PI,USD1,USD1,USDT,PI,USDT
PI,USDT,USDE,USDT,PI,USDE
PI,USDT,USDC,USDT,PI,USDC
PEAQ,USDT,USDC,USDT,PEAQ,USDC
KERNEL,USDT,USDC,USDT,KERNEL,USDC
AIXBT,USDT,USDC,USDT,AIXBT,USDC
TAO,EUR,EUR,USDT,TAO,USDT
TAO,EUR,EUR,USDC,TAO,USDC
TAO,USDT,USDC,USDT,TAO,USDC
RSR,ETH,RSR,USDT,ETH,USDT
ETH,BRL,BTC,BRL,ETH,BTC
ETH,BRL,BRL,USDT,ETH,USDT
ETH,BRL,MX,BRL,MX,ETH
ETH,BRL,USDC,BRL,ETH,USDC
ETH,BRL,XRP,BRL,XRP,ETH
ETH,EUR,BTC,EUR,ETH,BTC
ETH,EUR,EUR,USDT,ETH,USDT
ETH,EUR,MX,EUR,MX,ETH
ETH,EUR,EUR,USDC,ETH,USDC
ETH,EUR,XRP,EUR,XRP,ETH
ETH,EUR,LINK,EUR,LINK,ETH
ETH,BTC,BTC,USD1,ETH,USD1
ETH,BTC,BTC,USDT,ETH,USDT
ETH,BTC,IP,BTC,IP,ETH
ETH,BTC,BTC,USDF,ETH,USDF
ETH,BTC,MX,BTC,MX,ETH
ETH,BTC,BTC,USDE,ETH,USDE
ETH,BTC,BTC,USDC,ETH,USDC
ETH,BTC,XRP,BTC,XRP,ETH
ETH,USD1,USD1,USDT,ETH,USDT
ETH,USD1,XRP,USD1,XRP,ETH
ETH,USDT,IP,USDT,IP,ETH
ETH,USDT,USDF,USDT,ETH,USDF
ETH,USDT,MX,USDT,MX,ETH
ETH,USDT,UNI,USDT,UNI,ETH
ETH,USDT,USDE,USDT,ETH,USDE
ETH,USDT,NMR,USDT,NMR,ETH
ETH,USDT,OXT,USDT,OXT,ETH
ETH,USDT,USDC,USDT,ETH,USDC
ETH,USDT,SNX,USDT,SNX,ETH
ETH,USDT,XRP,USDT,XRP,ETH
ETH,USDT,LINK,USDT,LINK,ETH
ETH,USDT,CRV,USDT,CRV,ETH
ETH,USDT,AR,USDT,AR,ETH
IP,ETH,IP,USDC,ETH,USDC
ETH,USDF,USDC,USDF,ETH,USDC
MX,ETH,MX,USDC,ETH,USDC
UNI,ETH,UNI,USDC,ETH,USDC
ETH,USDE,XRP,USDE,XRP,ETH
ETH,USDC,XRP,USDC,XRP,ETH
ETH,USDC,LINK,USDC,LINK,ETH
ETH,USDC,CRV,USDC,CRV,ETH
ETH,USDC,AR,USDC,AR,ETH
BABYDOGE,USDT,USDC,USDT,BABYDOGE,USDC
APR,USDT,USDC,USDT,APR,USDC
KITE,USDT,USDC,USDT,KITE,USDC
FLOKI,USDT,USDC,USDT,FLOKI,USDC
RED,USDT,USDC,USDT,RED,USDC
DOLO,USDT,USDC,USDT,DOLO,USDC
WHITE,USDT,USDC,USDT,WHITE,USDC
QTUM,BTC,BTC,USDT,QTUM,USDT
HOLO,USDT,USDC,USDT,HOLO,USDC
ALCH,USDT,USDC,USDT,ALCH,USDC
RARE,USDT,USDC,USDT,RARE,USDC
SOMI,USDT,USDC,USDT,SOMI,USDC
NXPC,USDT,USDC,USDT,NXPC,USDC
ARB,USDT,USDC,USDT,ARB,USDC
MNT,USDT,USDC,USDT,MNT,USDC
SOL,BRL,BTC,BRL,SOL,BTC
SOL,BRL,BRL,USDT,SOL,USDT
SOL,BRL,USDC,BRL,SOL,USDC
SOL,EUR,BTC,EUR,SOL,BTC
SOL,EUR,EUR,USDT,SOL,USDT
SOL,EUR,EUR,USDC,SOL,USDC
SOL,BTC,BTC,USD1,SOL,USD1
SOL,BTC,BTC,USDT,SOL,USDT
SOL,BTC,BTC,USDE,SOL,USDE
SOL,BTC,BTC,USDC,SOL,USDC
SOL,USD1,USD1,USDT,SOL,USDT
SOL,USDT,USDE,USDT,SOL,USDE
SOL,USDT,USDC,USDT,SOL,USDC
HYPE,USDT,USDC,USDT,HYPE,USDC
TRX,BTC,BTC,USDT,TRX,USDT
TRX,BTC,BTC,USDE,TRX,USDE
TRX,BTC,BTC,USDC,TRX,USDC
TRX,USDT,USDE,USDT,TRX,USDE
TRX,USDT,USDC,USDT,TRX,USDC
FF,USDT,USDF,USDT,FF,USDF
NAKA,USDT,USDC,USDT,NAKA,USDC
BTC,BRL,BTC,USDT,BRL,USDT
BTC,BRL,MX,BTC,MX,BRL
BTC,BRL,BTC,USDC,USDC,BRL
BTC,BRL,XRP,BTC,XRP,BRL
BRL,USDT,VINE,USDT,VINE,BRL
BRL,USDT,MX,USDT,MX,BRL
BRL,USDT,USDC,USDT,USDC,BRL
BRL,USDT,XRP,USDT,XRP,BRL
MX,BRL,MX,USDC,USDC,BRL
USDC,BRL,XRP,USDC,XRP,BRL
POL,USDT,USDC,USDT,POL,USDC
NEO,BTC,BTC,USDT,NEO,USDT
NEO,BTC,BTC,USDC,NEO,USDC
NEO,USDT,USDC,USDT,NEO,USDC
PEPE,EUR,PEPE,USDT,EUR,USDT
PEPE,EUR,PEPE,USDC,USDC,EUR
LTC,EUR,LTC,BTC,BTC,EUR
LTC,EUR,LTC,USDT,EUR,USDT
LTC,EUR,LTC,USDC,USDC,EUR
BTC,EUR,BTC,USDT,EUR,USDT
BTC,EUR,MX,BTC,MX,EUR
BTC,EUR,ADA,BTC,ADA,EUR
BTC,EUR,BTC,USDC,USDC,EUR
BTC,EUR,XRP,BTC,XRP,EUR
DOGE,EUR,DOGE,USDT,EUR,USDT
DOGE,EUR,DOGE,USDC,USDC,EUR
MELANIA,EUR,MELANIA,USDT,EUR,USDT
MELANIA,EUR,MELANIA,USDC,USDC,EUR
SUI,EUR,SUI,USDT,EUR,USDT
SUI,EUR,SUI,USDC,USDC,EUR
RIO,EUR,RIO,USDT,EUR,USDT
RIO,EUR,RIO,USDC,USDC,EUR
EUR,USDT,MX,USDT,MX,EUR
EUR,USDT,AVAX,USDT,AVAX,EUR
EUR,USDT,ULTIMA,USDT,ULTIMA,EUR
EUR,USDT,TON,USDT,TON,EUR
EUR,USDT,WIF,USDT,WIF,EUR
EUR,USDT,ADA,USDT,ADA,EUR
EUR,USDT,USDC,USDT,USDC,EUR
EUR,USDT,SHIB,USDT,SHIB,EUR
EUR,USDT,TRUMP,USDT,TRUMP,EUR
EUR,USDT,KAS,USDT,KAS,EUR
EUR,USDT,XRP,USDT,XRP,EUR
EUR,USDT,LINK,USDT,LINK,EUR
MX,EUR,MX,USDC,USDC,EUR
AVAX,EUR,AVAX,USDC,USDC,EUR
ULTIMA,EUR,ULTIMA,USDC,USDC,EUR
TON,EUR,TON,USDC,USDC,EUR
WIF,EUR,WIF,USDC,USDC,EUR
ADA,EUR,ADA,USDC,USDC,EUR
EUR,USDC,SHIB,USDC,SHIB,EUR
EUR,USDC,TRUMP,USDC,TRUMP,EUR
EUR,USDC,KAS,USDC,KAS,EUR
EUR,USDC,XRP,USDC,XRP,EUR
EUR,USDC,LINK,USDC,LINK,EUR
FTT,USDT,USDC,USDT,FTT,USDC
PEPE,USDT,USDE,USDT,PEPE,USDE
PEPE,USDT,USDC,USDT,PEPE,USDC
PENDLE,USDT,USDC,USDT,PENDLE,USDC
BTR,USDT,USDC,USDT,BTR,USDC
ATOM,BTC,BTC,USDT,ATOM,USDT
ATOM,BTC,BTC,USDC,ATOM,USDC
ATOM,USDT,USDC,USDT,ATOM,USDC
TNSR,USDT,USDC,USDT,TNSR,USDC
ONT,BTC,BTC,USDT,ONT,USDT
SAPIEN,USDT,USDC,USDT,SAPIEN,USDC
BOOM,USDT,USDC,USDT,BOOM,USDC
SOPH,USDT,USDC,USDT,SOPH,USDC
STABLE,USDT,USDC,USDT,STABLE,USDC
DOOD,USDT,USDC,USDT,DOOD,USDC
TURBO,USDT,USDC,USDT,TURBO,USDC
APE,USDT,USDC,USDT,APE,USDC
WLFI,USD1,USD1,USDT,WLFI,USDT
WLFI,USDT,USDC,USDT,WLFI,USDC
XEN,USDT,USDC,USDT,XEN,USDC
BROCCOLIF3B,USDT,USDC,USDT,BROCCOLIF3B,USDC
LA,USD1,USD1,USDT,LA,USDT
LA,USDT,USDC,USDT,LA,USDC
LTC,BTC,BTC,USDT,LTC,USDT
LTC,BTC,BTC,USDC,LTC,USDC
LTC,USDT,USDC,USDT,LTC,USDC
SEI,USDT,USDC,USDT,SEI,USDC
BDX,BTC,BDX,USDT,BTC,USDT
BTC,USD1,USD1,USDT,BTC,USDT
BTC,USD1,XRP,USD1,XRP,BTC
BTC,USDT,ANKR,USDT,ANKR,BTC
BTC,USDT,DOT,USDT,DOT,BTC
BTC,USDT,IP,USDT,IP,BTC
BTC,USDT,DEXE,USDT,DEXE,BTC
BTC,USDT,USDF,USDT,BTC,USDF
BTC,USDT,BCH,USDT,BCH,BTC
BTC,USDT,MX,USDT,MX,BTC
BTC,USDT,OMG,USDT,OMG,BTC
BTC,USDT,A,USDT,A,BTC
BTC,USDT,USDE,USDT,BTC,USDE
BTC,USDT,WBTC,USDT,WBTC,BTC
BTC,USDT,ADA,USDT,ADA,BTC
BTC,USDT,USDC,USDT,BTC,USDC
BTC,USDT,DASH,USDT,DASH,BTC
BTC,USDT,XLM,USDT,XLM,BTC
BTC,USDT,XRP,USDT,XRP,BTC
DOT,BTC,DOT,USDC,BTC,USDC
IP,BTC,IP,USDC,BTC,USDC
BTC,USDF,USDC,USDF,BTC,USDC
BCH,BTC,BCH,USDC,BTC,USDC
MX,BTC,MX,USDC,BTC,USDC
A,BTC,A,USDC,BTC,USDC
BTC,USDE,XRP,USDE,XRP,BTC
WBTC,BTC,WBTC,USDC,BTC,USDC
ADA,BTC,ADA,USDC,BTC,USDC
BTC,USDC,DASH,USDC,DASH,BTC
BTC,USDC,XLM,USDC,XLM,BTC
BTC,USDC,XRP,USDC,XRP,BTC
0G,USDT,USDC,USDT,0G,USDC
HBAR,USDT,USDC,USDT,HBAR,USDC
EIGEN,USDT,USDC,USDT,EIGEN,USDC
PROVE,USDT,USDC,USDT,PROVE,USDC
TIA,USDT,USDC,USDT,TIA,USDC
COTI,USDT,USDC,USDT,COTI,USDC
DOGE,USDT,USDE,USDT,DOGE,USDE
DOGE,USDT,USDC,USDT,DOGE,USDC
MELANIA,USD1,USD1,USDT,MELANIA,USDT
MELANIA,USDT,USDC,USDT,MELANIA,USDC
BONK,USDT,USDC,USDT,BONK,USDC
ACH,USDT,USDC,USDT,ACH,USDC
MON,USDT,USDC,USDT,MON,USDC
SUI,USDT,USDE,USDT,SUI,USDE
SUI,USDT,USDC,USDT,SUI,USDC
HEMI,USDT,USDC,USDT,HEMI,USDC
ICP,USDT,USDC,USDT,ICP,USDC
GAIB,USDT,USDC,USDT,GAIB,USDC
SPK,USDT,USDC,USDT,SPK,USDC
FLK,USDT,USDC,USDT,FLK,USDC
RWA,USDT,USDC,USDT,RWA,USDC
ZBCN,USDT,USDC,USDT,ZBCN,USDC
ZKC,USDT,USDC,USDT,ZKC,USDC
FHE,USDT,USDC,USDT,FHE,USDC
FET,USDT,USDC,USDT,FET,USDC
PARTI,USDT,USDC,USDT,PARTI,USDC
LDO,USDT,USDC,USDT,LDO,USDC
MUBARAK,USDT,USDC,USDT,MUBARAK,USDC
RIO,USDT,USDC,USDT,RIO,USDC
USELESS,USDT,USDC,USDT,USELESS,USDC
PNUT,USDT,USDC,USDT,PNUT,USDC
HOME,USDT,USDC,USDT,HOME,USDC
ALLO,USDT,USDC,USDT,ALLO,USDC
HYPER,USDT,USDC,USDT,HYPER,USDC
CFX,USDT,USDC,USDT,CFX,USDC
LINEA,USDT,USDC,USDT,LINEA,USDC
OPEN,USDT,USDC,USDT,OPEN,USDC
USD1,USDT,BANK,USDT,BANK,USD1
USD1,USDT,SAHARA,USDT,SAHARA,USD1
USD1,USDT,B,USDT,B,USD1
USD1,USDT,TAG,USDT,TAG,USD1
USD1,USDT,TRUMP,USDT,TRUMP,USD1
USD1,USDT,KAS,USDT,KAS,USD1
USD1,USDT,XRP,USDT,XRP,USD1
ERA,USDT,USDC,USDT,ERA,USDC
WAL,USDT,USDC,USDT,WAL,USDC
FIL,USDT,USDC,USDT,FIL,USDC
SOSO,USDT,USDC,USDT,SOSO,USDC
ROSE,USDT,USDC,USDT,ROSE,USDC
MYX,USDT,USDC,USDT,MYX,USDC
ALGO,USDT,USDC,USDT,ALGO,USDC
ZBT,USDT,ZBT,USDC,USDC,USDT
XMR,USDT,XMR,USDC,USDC,USDT
BNB,USDT,BNB,USDC,USDC,USDT
MET,USDT,MET,USDC,USDC,USDT
VIRTUAL,USDT,VIRTUAL,USDC,USDC,USDT
DSYNC,USDT,DSYNC,USDC,USDC,USDT
DOT,USDT,DOT,USDC,USDC,USDT
OBOL,USDT,OBOL,USDC,USDC,USDT
IP,USDT,IP,USDC,USDC,USDT
MILK,USDT,MILK,USDC,USDC,USDT
CGPT,USDT,CGPT,USDC,USDC,USDT
RBNT,USDT,RBNT,USDC,USDC,USDT
ELDE,USDT,ELDE,USDC,USDC,USDT
IDOL,USDT,IDOL,USDC,USDC,USDT
CAKE,USDT,CAKE,USDC,USDC,USDT
MORE,USDT,MORE,USDC,USDC,USDT
IDEX,USDT,IDEX,USDC,USDC,USDT
USUAL,USDT,USUAL,USDC,USDC,USDT
RENDER,USDT,RENDER,USDC,USDC,USDT
PENGU,USDT,PENGU,USDC,USDC,USDT
1DOLLAR,USDT,1DOLLAR,USDC,USDC,USDT
ZEN,USDT,ZEN,USDC,USDC,USDT
KILO,USDT,KILO,USDC,USDC,USDT
ENA,USDT,ENA,USDE,USDE,USDT
ENA,USDT,ENA,USDC,USDC,USDT
BANK,USDT,BANK,USDC,USDC,USDT
NODE,USDT,NODE,USDC,USDC,USDT
XPL,USDT,XPL,USDC,USDC,USDT
SAHARA,USDT,SAHARA,USDC,USDC,USDT
OP,USDT,OP,USDC,USDC,USDT
VANRY,USDT,VANRY,USDC,USDC,USDT
USDF,USDT,USDC,USDF,USDC,USDT
XAN,USDT,XAN,USDC,USDC,USDT
GHIBLI,USDT,GHIBLI,USDC,USDC,USDT
BCH,USDT,BCH,USDC,USDC,USDT
MX,USDT,MX,USDC,USDC,USDT
AVAX,USDT,AVAX,USDC,USDC,USDT
ZORA,USDT,ZORA,USDC,USDC,USDT
ASTER,USDT,ASTER,USDC,USDC,USDT
BANANA,USDT,BANANA,USDC,USDC,USDT
ARKM,USDT,ARKM,USDC,USDC,USDT
ZK,USDT,ZK,USDC,USDC,USDT
ULTIMA,USDT,ULTIMA,USDE,USDE,USDT
ULTIMA,USDT,ULTIMA,USDC,USDC,USDT
TON,USDT,TON,USDC,USDC,USDT
ORCA,USDT,ORCA,USDC,USDC,USDT
BMT,USDT,BMT,USDC,USDC,USDT
BLESS,USDT,BLESS,USDC,USDC,USDT
BDXN,USDT,BDXN,USDC,USDC,USDT
PRAI,USDT,PRAI,USDC,USDC,USDT
B2,USDT,B2,USDC,USDC,USDT
VELVET,USDT,VELVET,USDC,USDC,USDT
LINGO,USDT,LINGO,USDC,USDC,USDT
UNI,USDT,UNI,USDC,USDC,USDT
BUTTHOLE,USDT,BUTTHOLE,USDC,USDC,USDT
DOGS,USDT,DOGS,USDC,USDC,USDT
NEWT,USDT,NEWT,USDC,USDC,USDT
LUNC,USDT,LUNC,USDC,USDC,USDT
MINA,USDT,MINA,USDC,USDC,USDT
HUMA,USDT,HUMA,USDC,USDC,USDT
AAVE,USDT,AAVE,USDC,USDC,USDT
SKATE,USDT,SKATE,USDC,USDC,USDT
ES,USDT,ES,USDC,USDC,USDT
C,USDT,C,USDC,USDC,USDT
ZRO,USDT,ZRO,USDC,USDC,USDT
WIF,USDT,WIF,USDC,USDC,USDT
AIOT,USDT,AIOT,USDC,USDC,USDT
INJ,USDT,INJ,USDC,USDC,USDT
H,USDT,H,USDC,USDC,USDT
INIT,USDT,INIT,USDC,USDC,USDT
LOT,USDT,LOT,USDC,USDC,USDT
KEKIUS,USDT,KEKIUS,USDC,USDC,USDT
SEN,USDT,SEN,USDC,USDC,USDT
QUBIC,USDT,QUBIC,USDC,USDC,USDT
PAXG,USDT,PAXG,USDC,USDC,USDT
A,USDT,A,USDC,USDC,USDT
USDE,USDT,KAS,USDE,KAS,USDT
USDE,USDT,XRP,USDE,XRP,USDT
AZERO,USDT,AZERO,USDC,USDC,USDT
OBT,USDT,OBT,USDC,USDC,USDT
NPC,USDT,NPC,USDC,USDC,USDT
RUNE,USDT,RUNE,USDC,USDC,USDT
ZEC,USDT,ZEC,USDC,USDC,USDT
KAITO,USDT,KAITO,USDC,USDC,USDT
FLOCK,USDT,FLOCK,USDC,USDC,USDT
TREE,USDT,TREE,USDC,USDC,USDT
BOB,USDT,BOB,USDC,USDC,USDT
CAW,USDT,CAW,USDC,USDC,USDT
S,USDT,S,USDC,USDC,USDT
PROMPT,USDT,PROMPT,USDC,USDC,USDT
JASMY,USDT,JASMY,USDC,USDC,USDT
BOMB,USDT,BOMB,USDC,USDC,USDT
BLUM,USDT,BLUM,USDC,USDC,USDT
ONDO,USDT,ONDO,USDC,USDC,USDT
ENS,USDT,ENS,USDC,USDC,USDT
WLD,USDT,WLD,USDC,USDC,USDT
SPX,USDT,SPX,USDC,USDC,USDT
WBTC,USDT,WBTC,USDC,USDC,USDT
SIGN,USDT,SIGN,USDC,USDC,USDT
SUPRA,USDT,SUPRA,USDC,USDC,USDT
BARD,USDT,BARD,USDC,USDC,USDT
IRYS,USDT,IRYS,USDC,USDC,USDT
CAMP,USDT,CAMP,USDC,USDC,USDT
RECALL,USDT,RECALL,USDC,USDC,USDT
XCN,USDT,XCN,USDC,USDC,USDT
PUMPBTC,USDT,PUMPBTC,USDC,USDC,USDT
MOONPIG,USDT,MOONPIG,USDC,USDC,USDT
CGN,USDT,CGN,USDC,USDC,USDT
GRIFFAIN,USDT,GRIFFAIN,USDC,USDC,USDT
CC,USDT,CC,USDC,USDC,USDT
ADA,USDT,ADA,USDC,USDC,USDT
USDC,USDT,SOON,USDC,SOON,USDT
USDC,USDT,BKN,USDC,BKN,USDT
USDC,USDT,BABY,USDC,BABY,USDT
USDC,USDT,AVNT,USDC,AVNT,USDT
USDC,USDT,STO,USDC,STO,USDT
USDC,USDT,SXT,USDC,SXT,USDT
USDC,USDT,CHZ,USDC,CHZ,USDT
USDC,USDT,MIRA,USDC,MIRA,USDT
USDC,USDT,BANANAS31,USDC,BANANAS31,USDT
USDC,USDT,POPCAT,USDC,POPCAT,USDT
USDC,USDT,APT,USDC,APT,USDT
USDC,USDT,ART,USDC,ART,USDT
USDC,USDT,EPT,USDC,EPT,USDT
USDC,USDT,SHIB,USDC,SHIB,USDT
USDC,USDT,PLUME,USDC,PLUME,USDT
USDC,USDT,AT,USDC,AT,USDT
USDC,USDT,TOWNS,USDC,TOWNS,USDT
USDC,USDT,OMI,USDC,OMI,USDT
USDC,USDT,TRUMP,USDC,TRUMP,USDT
USDC,USDT,GUN,USDC,GUN,USDT
USDC,USDT,NIL,USDC,NIL,USDT
USDC,USDT,XDC,USDC,XDC,USDT
USDC,USDT,DASH,USDC,DASH,USDT
USDC,USDT,AERGO,USDC,AERGO,USDT
USDC,USDT,XVG,USDC,XVG,USDT
USDC,USDT,EGLD,USDC,EGLD,USDT
USDC,USDT,BERA,USDC,BERA,USDT
USDC,USDT,KAS,USDC,KAS,USDT
USDC,USDT,XLM,USDC,XLM,USDT
USDC,USDT,RAI,USDC,RAI,USDT
USDC,USDT,XRP,USDC,XRP,USDT
USDC,USDT,LINK,USDC,LINK,USDT
USDC,USDT,GIGGLE,USDC,GIGGLE,USDT
USDC,USDT,CRV,USDC,CRV,USDT
USDC,USDT,FARTCOIN,USDC,FARTCOIN,USDT
USDC,USDT,AR,USDC,AR,USDT
USDC,USDT,NEAR,USDC,NEAR,USDT
USDC,USDT,KAIA,USDC,KAIA,USDT
USDC,USDT,WAVES,USDC,WAVES,USDT
USDC,USDT,WCT,USDC,WCT,USDT
USDC,USDT,QNT,USDC,QNT,USDT



package main

import (
	"context"
	"encoding/csv"
	"encoding/json"
	"fmt"
	"log"
	"os"
	"os/signal"
	"strconv"
	"strings"
	"sync"
	"syscall"
	"time"

	"github.com/gorilla/websocket"
	"github.com/joho/godotenv"
	"google.golang.org/protobuf/proto"

	pb "crypt_proto/pb" // твои *.pb.go (MEXC v3)
)

/* =========================  CONFIG  ========================= */

type Config struct {
	BookInterval string // "100ms" | "10ms"
	Debug        bool
	SymbolsFile  string // файл с треугольниками (или парами), по умолч. triangles_markets.csv
}

func loadConfig() (Config, error) {
	_ = godotenv.Load(".env")

	cfg := Config{
		BookInterval: os.Getenv("BOOK_INTERVAL"),
		SymbolsFile:  os.Getenv("SYMBOLS_FILE"),
	}

	if cfg.BookInterval == "" {
		cfg.BookInterval = "100ms"
	}
	if cfg.SymbolsFile == "" {
		cfg.SymbolsFile = "triangles_markets.csv"
	}
	if strings.ToLower(os.Getenv("DEBUG")) == "true" {
		cfg.Debug = true
	}

	return cfg, nil
}

/* =========================  LOGGING  ========================= */

var debug bool

func dlog(format string, args ...any) {
	if debug {
		log.Printf(format, args...)
	}
}

/* =========================  EVENTS  ========================= */

type Event struct {
	Symbol string
	Mid    float64
}

/* =========================  PROТО DECODER  ========================= */

// Пул для protobuf-структуры, чтобы не аллоцировать на каждый тик
var wrapperPool = sync.Pool{
	New: func() any { return new(pb.PushDataV3ApiWrapper) },
}

// Возвращаем символ и mid=(bid+ask)/2, если это (aggre.)bookTicker
func parsePBWrapperMid(raw []byte) (sym string, mid float64, ok bool) {
	w, _ := wrapperPool.Get().(*pb.PushDataV3ApiWrapper)
	defer func() {
		*w = pb.PushDataV3ApiWrapper{} // очищаем
		wrapperPool.Put(w)
	}()

	if err := proto.Unmarshal(raw, w); err != nil {
		return "", 0, false
	}

	sym = w.GetSymbol()
	if sym == "" {
		ch := w.GetChannel()
		if i := strings.LastIndex(ch, "@"); i >= 0 && i+1 < len(ch) {
			sym = ch[i+1:]
		}
	}
	if sym == "" {
		return "", 0, false
	}

	// PublicBookTicker
	if b1, ok1 := w.GetBody().(*pb.PushDataV3ApiWrapper_PublicBookTicker); ok1 && b1.PublicBookTicker != nil {
		bp := b1.PublicBookTicker.GetBidPrice()
		ap := b1.PublicBookTicker.GetAskPrice()
		if bp == "" || ap == "" {
			return "", 0, false
		}
		bid, err1 := strconv.ParseFloat(bp, 64)
		ask, err2 := strconv.ParseFloat(ap, 64)
		if err1 != nil || err2 != nil || bid <= 0 || ask <= 0 {
			return "", 0, false
		}
		return sym, (bid + ask) / 2, true
	}

	// PublicAggreBookTicker
	if b2, ok2 := w.GetBody().(*pb.PushDataV3ApiWrapper_PublicAggreBookTicker); ok2 && b2.PublicAggreBookTicker != nil {
		bp := b2.PublicAggreBookTicker.GetBidPrice()
		ap := b2.PublicAggreBookTicker.GetAskPrice()
		if bp == "" || ap == "" {
			return "", 0, false
		}
		bid, err1 := strconv.ParseFloat(bp, 64)
		ask, err2 := strconv.ParseFloat(ap, 64)
		if err1 != nil || err2 != nil || bid <= 0 || ask <= 0 {
			return "", 0, false
		}
		return sym, (bid + ask) / 2, true
	}

	return "", 0, false
}

/* =========================  ЗАГРУЗКА СИМВОЛОВ ИЗ CSV  ========================= */

// Ожидаем файл вида:
// base1,quote1,base2,quote2,base3,quote3
// ETC,BTC,BTC,USDC,ETC,USDC
// ...
// Берём все base/quote, собираем уникальные символы BASE+QUOTE.
func loadSymbolsFromTriangles(path string) ([]string, error) {
	f, err := os.Open(path)
	if err != nil {
		return nil, fmt.Errorf("open %s: %w", path, err)
	}
	defer f.Close()

	r := csv.NewReader(f)

	// читаем заголовок
	if _, err := r.Read(); err != nil {
		return nil, fmt.Errorf("read header: %w", err)
	}

	seen := make(map[string]struct{})

	for {
		rec, err := r.Read()
		if err != nil {
			if err.Error() == "EOF" {
				break
			}
			return nil, fmt.Errorf("read record: %w", err)
		}
		if len(rec) < 6 {
			continue
		}

		// три рынка (base, quote)
		bases := []string{rec[0], rec[2], rec[4]}
		quotes := []string{rec[1], rec[3], rec[5]}

		for i := 0; i < 3; i++ {
			base := strings.TrimSpace(bases[i])
			quote := strings.TrimSpace(quotes[i])
			if base == "" || quote == "" {
				continue
			}
			sym := base + quote // формат MEXC: BTC + USDT = BTCUSDT
			seen[sym] = struct{}{}
		}
	}

	symbols := make([]string, 0, len(seen))
	for s := range seen {
		symbols = append(symbols, s)
	}
	return symbols, nil
}

/* =========================  WS RUNNER (PUBLIC)  ========================= */

func runPublicBookTicker(ctx context.Context, wg *sync.WaitGroup, symbols []string, interval string, out chan<- Event) {
	defer wg.Done()

	if len(symbols) == 0 {
		log.Println("[PUB] нет символов для подписки")
		return
	}

	const (
		baseRetry = 2 * time.Second
		maxRetry  = 30 * time.Second
	)

	urlWS := "wss://wbs-api.mexc.com/ws"

	// формируем список топиков
	params := make([]string, 0, len(symbols))
	for _, sym := range symbols {
		topic := "spot@public.aggre.bookTicker.v3.api.pb@" + interval + "@" + sym
		params = append(params, topic)
	}
	log.Printf("[PUB] всего символов для подписки: %d", len(params))

	retry := baseRetry

	for {
		select {
		case <-ctx.Done():
			return
		default:
		}

		conn, _, err := websocket.DefaultDialer.Dial(urlWS, nil)
		if err != nil {
			log.Printf("[PUB] dial err: %v (retry in %v)", err, retry)
			time.Sleep(retry)
			if retry < maxRetry {
				retry *= 2
				if retry > maxRetry {
					retry = maxRetry
				}
			}
			continue
		}
		log.Printf("[PUB] connected to %s", urlWS)
		retry = baseRetry

		_ = conn.SetReadDeadline(time.Now().Add(90 * time.Second))

		var lastPing time.Time
		conn.SetPongHandler(func(appData string) error {
			rtt := time.Since(lastPing)
			dlog("[PING] Pong от %s через %v", urlWS, rtt)
			return conn.SetReadDeadline(time.Now().Add(90 * time.Second))
		})

		// keepalive (PING)
		stopPing := make(chan struct{})
		go func() {
			t := time.NewTicker(45 * time.Second)
			defer t.Stop()
			for {
				select {
				case <-t.C:
					lastPing = time.Now()
					if err := conn.WriteControl(websocket.PingMessage, []byte("hb"), time.Now().Add(5*time.Second)); err != nil {
						dlog("⚠️ [PING] send error: %v", err)
						return
					}
					dlog("[PING] Sent at %s", lastPing.Format("15:04:05.000"))
				case <-stopPing:
					return
				}
			}
		}()

		// подписка на все топики одним запросом
		sub := map[string]any{
			"method": "SUBSCRIPTION",
			"params": params,
			"id":     time.Now().Unix(),
		}
		if err := conn.WriteJSON(sub); err != nil {
			log.Printf("[PUB] subscribe send err: %v", err)
			close(stopPing)
			_ = conn.Close()
			time.Sleep(retry)
			continue
		}
		log.Printf("[PUB] SUB → %d топиков", len(params))

		// цикл чтения
		for {
			mt, raw, err := conn.ReadMessage()
			if err != nil {
				log.Printf("[PUB] read err: %v (reconnect)", err)
				break
			}

			switch mt {
			case websocket.TextMessage:
				// ACK/ошибки подписки и т.п. — только в debug
				var tmp any
				if err := json.Unmarshal(raw, &tmp); err == nil {
					j, _ := json.Marshal(tmp)
					dlog("[PUB TEXT] %s", string(j))
				} else {
					dlog("[PUB TEXT RAW] %s", string(raw))
				}
			case websocket.BinaryMessage:
				if sym, mid, ok := parsePBWrapperMid(raw); ok {
					ev := Event{Symbol: sym, Mid: mid}
					select {
					case out <- ev:
					case <-ctx.Done():
						close(stopPing)
						_ = conn.Close()
						return
					}
				}
			default:
				// игнорируем прочие типы
			}
		}

		// cleanup + реконнект
		close(stopPing)
		_ = conn.Close()
		time.Sleep(retry)
		if retry < maxRetry {
			retry *= 2
			if retry > maxRetry {
				retry = maxRetry
			}
		}
	}
}

/* =========================  MAIN  ========================= */

func main() {
	log.SetFlags(log.LstdFlags | log.Lmicroseconds)

	cfg, err := loadConfig()
	if err != nil {
		log.Fatal(err)
	}
	debug = cfg.Debug

	// грузим символы из triangles_markets.csv (или другого файла)
	symbols, err := loadSymbolsFromTriangles(cfg.SymbolsFile)
	if err != nil {
		log.Fatalf("load symbols: %v", err)
	}
	if len(symbols) == 0 {
		log.Fatal("нет символов в файле ", cfg.SymbolsFile)
	}
	log.Printf("символов для подписки: %d", len(symbols))

	ctx, cancel := signal.NotifyContext(context.Background(), syscall.SIGINT, syscall.SIGTERM)
	defer cancel()

	events := make(chan Event, 8192)

	var wg sync.WaitGroup
	wg.Add(1)
	go runPublicBookTicker(ctx, &wg, symbols, cfg.BookInterval, events)

	// Консумер: хранит последний mid по символу, печатает агрегированно раз в секунду
	go func() {
		lastMid := make(map[string]float64)
		ticker := time.NewTicker(1 * time.Second)
		defer ticker.Stop()

		for {
			select {
			case ev, ok := <-events:
				if !ok {
					return
				}
				lastMid[ev.Symbol] = ev.Mid
			case <-ticker.C:
				// здесь ты потом будешь запускать движок треугольников
				for sym, mid := range lastMid {
					fmt.Printf("[MID] %s = %.10f\n", sym, mid)
				}
			}
		}
	}()

	<-ctx.Done()

	time.Sleep(300 * time.Millisecond)
	close(events)
	wg.Wait()
	log.Println("bye")
}




